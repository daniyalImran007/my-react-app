name: CD Pipeline (Vercel)

# === TRIGGERS ===
on:
  push:
    branches: [ main ]  # Deploy to Production
  pull_request:
    types: [ opened, synchronize, reopened ]  # Preview URLs

# === CONCURRENCY ===
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# === PERMISSIONS ===
permissions:
  contents: read
  deployments: write
  pull-requests: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'preview' }}

    steps:
      # --- 1. Checkout Code ---
      - name: Checkout
        uses: actions/checkout@v4

      # --- 2. Download Build Artifact from CI ---
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: react-build-node-20.x  # Match from CI (use latest stable)
          path: build/

      # --- 3. Deploy to Vercel ---
      - name: Deploy to Vercel
        id: vercel_deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'  # Only for main
          working-directory: .
          alias-domains: |
            ${{ github.event.pull_request.number && format('pr-{0}-{1}.vercel.app', github.event.pull_request.number, github.repository_owner) || '' }}
        env:
          VERCEL_ENV: ${{ github.ref == 'refs/heads/main' && 'production' || 'preview' }}

      # --- 4. Output Deployment URL ---
      - name: Get Deployment URL
        run: |
          echo "Deployment URL: ${{ steps.vercel_deploy.outputs.preview-url || steps.vercel_deploy.outputs.url }}"
          echo "preview-url=${{ steps.vercel_deploy.outputs.preview-url }}" >> $GITHUB_OUTPUT
          echo "prod-url=${{ steps.vercel_deploy.outputs.url }}" >> $GITHUB_OUTPUT

      # --- 5. Smoke Test (Health Check) ---
      - name: Smoke Test Deployed App
        run: |
          URL="${{ steps.vercel_deploy.outputs.preview-url || steps.vercel_deploy.outputs.url }}"
          echo "Testing: $URL"
          sleep 10  # Wait for DNS/propagation
          curl -f -L "$URL" || exit 1

      # --- 6. Comment PR with Preview URL ---
      - name: Comment PR with Preview URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const url = "${{ steps.vercel_deploy.outputs.preview-url }}";
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `Preview URL: ${url}`
            })

      # --- 7. Notify Slack on Success/Failure ---
      # - name: Notify Slack
      #   uses: slackapi/slack-github-action@v1.26.0
      #   with:
      #     payload: |
      #       {
      #         "text": "${{ github.ref == 'refs/heads/main' && ':rocket: *Production Deployed!*' || ':eyes: *Preview Deployed*' }}\n<${{ steps.vercel_deploy.outputs.url || steps.vercel_deploy.outputs.preview-url }}|View Live> | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Workflow Run>"
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}